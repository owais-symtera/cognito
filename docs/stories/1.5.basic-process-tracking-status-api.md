# Story 1.5: Basic Process Tracking & Status API

## Status
Ready

## Story
**As a** Business Development Manager,
**I want** to query the status of my submitted drug analysis requests with complete transparency,
**so that** I can provide accurate timelines to stakeholders and maintain audit compliance for pharmaceutical business processes.

## Acceptance Criteria
1. GET /api/v1/status/{processId} endpoint returning current processing stage and estimated completion
2. Process status tracking through states: submitted, collecting, verifying, merging, summarizing, completed, failed
3. All status changes logged to audit trail with timestamps and automated system reasoning
4. Error handling and appropriate HTTP status codes for invalid processId requests
5. Status response includes: processId, requestID, current_stage, progress_percentage, estimated_completion, error_details, audit_summary
6. Process history API showing complete status progression for pharmaceutical compliance reviews
7. Bulk status query support for monitoring multiple concurrent pharmaceutical analyses

## Tasks / Subtasks
- [ ] Implement status query API endpoint (AC: 1)
  - [ ] Create GET /api/v1/status/{processId} endpoint
  - [ ] Design status response schema with comprehensive details
  - [ ] Add proper error handling for invalid process IDs
  - [ ] Implement authentication and authorization for status queries
- [ ] Build process status tracking system (AC: 2)
  - [ ] Define all processing states in enum
  - [ ] Create status transition logic in database
  - [ ] Implement status update methods in core processor
  - [ ] Add state validation to prevent invalid transitions
- [ ] Implement comprehensive audit logging (AC: 3)
  - [ ] Log all status transitions with timestamps
  - [ ] Record automated reasoning for each status change
  - [ ] Track processing time for each stage
  - [ ] Implement audit trail queries for status history
- [ ] Add robust error handling (AC: 4)
  - [ ] Return 404 for non-existent process IDs
  - [ ] Return 403 for unauthorized access attempts
  - [ ] Add rate limiting for status queries
  - [ ] Implement proper error response schemas
- [ ] Design comprehensive status response (AC: 5)
  - [ ] Include all required fields: processId, requestID, stage, progress
  - [ ] Add estimated completion time calculation
  - [ ] Include error details when failures occur
  - [ ] Provide audit summary for compliance tracking
- [ ] Create process history API (AC: 6)
  - [ ] Implement GET /api/v1/status/{processId}/history endpoint
  - [ ] Return complete status progression with timestamps
  - [ ] Include processing duration for each stage
  - [ ] Add filtering options for specific time ranges
- [ ] Build bulk status query capability (AC: 7)
  - [ ] Create POST /api/v1/status/bulk endpoint
  - [ ] Accept array of process IDs for batch queries
  - [ ] Return status for all valid IDs with error details for invalid ones
  - [ ] Implement efficient database queries for bulk operations
- [ ] Write comprehensive status API tests
  - [ ] Test status queries for all processing states
  - [ ] Test error handling with invalid process IDs
  - [ ] Test authentication and authorization
  - [ ] Test bulk query functionality
  - [ ] Test audit trail completeness
  - [ ] Test estimated completion accuracy

## Dev Notes

### Previous Story Insights
Depends on Stories 1.1-1.4 for infrastructure, database models, API framework, and request handling.

### Process Status States
**Processing States Enum**:
```python
class ProcessingStatus(str, Enum):
    SUBMITTED = "submitted"
    COLLECTING = "collecting"     # Gathering data from APIs
    VERIFYING = "verifying"       # Source verification
    MERGING = "merging"           # Conflict resolution and data merging
    SUMMARIZING = "summarizing"   # Final summary generation
    COMPLETED = "completed"       # Successfully finished
    FAILED = "failed"             # Processing failure
```

### Status API Implementation [Source: architecture/data-models.md]
**Status Response Schema**:
```python
class ProcessStatusResponse(BaseModel):
    process_id: str
    request_id: str
    current_stage: ProcessingStatus
    progress_percentage: int  # 0-100
    estimated_completion: Optional[str]  # ISO datetime
    error_details: Optional[str]
    audit_summary: AuditSummary

    class AuditSummary(BaseModel):
        total_stages_completed: int
        current_stage_start_time: str
        processing_duration: str  # HH:MM:SS format
        categories_completed: int
        categories_total: int
```

### Database Status Tracking
**Process Tracking Table Extensions**:
```python
class ProcessTracking(Base):
    __tablename__ = "process_tracking"

    id: str = Field(primary_key=True)
    request_id: str = Field(foreign_key="drug_requests.id")
    current_status: ProcessingStatus = Field(default=ProcessingStatus.SUBMITTED)
    progress_percentage: int = Field(default=0)
    estimated_completion: Optional[datetime] = None
    current_stage_start: datetime = Field(default_factory=datetime.utcnow)
    error_details: Optional[str] = None

    # Stage completion tracking
    submitted_at: datetime = Field(default_factory=datetime.utcnow)
    collecting_started_at: Optional[datetime] = None
    collecting_completed_at: Optional[datetime] = None
    verifying_started_at: Optional[datetime] = None
    verifying_completed_at: Optional[datetime] = None
    merging_started_at: Optional[datetime] = None
    merging_completed_at: Optional[datetime] = None
    summarizing_started_at: Optional[datetime] = None
    summarizing_completed_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None
```

### Real-time Status Updates [Source: architecture/backend-architecture.md]
**Background Processing Integration**:
```python
# In SourceAwareCategoryProcessor
async def _update_processing_status(
    self,
    request_id: str,
    status: ProcessingStatus,
    progress: int,
    estimated_completion: Optional[datetime] = None
):
    """Update processing status with audit trail and real-time notifications"""

    # Update database
    await self._update_status_in_db(request_id, status, progress)

    # Log to audit trail
    await self.audit_logger.log_status_change(request_id, status, progress)

    # Broadcast via WebSocket
    await self._broadcast_status_update(request_id, status, progress)
```

### Bulk Query Optimization
**Efficient Database Queries**:
```python
async def get_bulk_status(self, process_ids: List[str]) -> List[ProcessStatusResponse]:
    """Efficiently query multiple process statuses"""
    query = select(ProcessTracking).where(ProcessTracking.id.in_(process_ids))
    results = await self.db.execute(query)
    return [self._build_status_response(row) for row in results.scalars()]
```

### File Locations
**Backend Status API Files**:
- `apps/backend/src/api/v1/status.py` - Status query endpoints
- `apps/backend/src/core/status_tracker.py` - Status tracking logic
- `apps/backend/src/schemas/status.py` - Status response schemas
- `apps/backend/src/database/repositories/status_repo.py` - Status repository

### Progress Calculation Logic
**Progress Percentage Calculation**:
- Submitted: 0%
- Collecting: 20% + (categories_completed / 17) * 60%
- Verifying: 80% + (verification_progress) * 10%
- Merging: 90% + (merge_progress) * 5%
- Summarizing: 95% + (summary_progress) * 4%
- Completed: 100%

### Estimated Completion Algorithm
Based on:
- Historical processing times for similar requests
- Current system load and API rate limits
- Category complexity and current progress
- Real-time updates as processing progresses

### Testing Standards
**Status API Testing Requirements**:
- Test status queries for all processing states
- Test progress percentage accuracy
- Test estimated completion time calculations
- Test bulk query performance with large datasets
- Test audit trail completeness for status changes

## Testing

### Testing Standards
**Test File Locations**:
- `apps/backend/tests/integration/api/test_status.py` - Status API tests
- `apps/backend/tests/unit/core/test_status_tracker.py` - Status tracking tests
- `apps/backend/tests/integration/test_bulk_queries.py` - Bulk query tests

**Testing Frameworks**:
- pytest with asyncio for async API testing
- Database fixtures for status state testing
- Mock time dependencies for estimated completion testing

**Required Tests**:
- Test GET /api/v1/status/{processId} for all processing states
- Test status history endpoint with complete progression
- Test bulk status queries with mixed valid/invalid IDs
- Test error handling for non-existent process IDs
- Test audit trail logging for all status transitions
- Test progress percentage accuracy throughout processing

### Critical Test Cases
- Test status updates during actual pharmaceutical processing
- Test estimated completion accuracy under different system loads
- Test concurrent status updates for multiple requests
- Test status persistence across system restarts
- Test audit compliance for regulatory reviews

### Performance Requirements
- Status query response time: < 100ms
- Bulk query performance: 50 IDs in < 500ms
- Status update latency: < 50ms via WebSocket
- Audit trail query performance: < 200ms

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section has been populated by the development agent during implementation*

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Status schema design: apps/backend/src/schemas/status.py
- Status tracking core: apps/backend/src/core/status_tracker.py
- API endpoints: apps/backend/src/api/v1/status.py
- Database model updates: apps/backend/src/database/models.py (ProcessTracking)
- Migration: apps/backend/alembic/versions/005_update_process_tracking_for_status.py

### Completion Notes List
- ✅ **COMPLETED**: Created comprehensive status response schemas with ProcessingStatus enum
- ✅ **COMPLETED**: Built process status tracking system with state transitions
- ✅ **COMPLETED**: Implemented GET /api/v1/status/{processId} endpoint
- ✅ **COMPLETED**: Created process history API endpoint
- ✅ **COMPLETED**: Implemented bulk status query capability (POST /api/v1/status/bulk)
- ✅ **COMPLETED**: Added progress percentage calculation logic
- ✅ **COMPLETED**: Implemented estimated completion time algorithm
- ✅ **COMPLETED**: Created comprehensive audit summary in responses
- ✅ **COMPLETED**: Added processing metrics endpoint
- ✅ **COMPLETED**: Updated ProcessTracking model with detailed stage tracking
- ✅ **COMPLETED**: Created migration for database schema changes
- ✅ **COMPLETED**: Integrated routes into main FastAPI application
- ⚠️ **NOTE**: Audit logging integration pending (uses placeholder for now)
- ⚠️ **NOTE**: WebSocket real-time updates to be implemented in separate story

### File List
**Schemas:**
- apps/backend/src/schemas/status.py - Status tracking schemas and enums

**Core Logic:**
- apps/backend/src/core/status_tracker.py - Status tracking and management system

**API Layer:**
- apps/backend/src/api/v1/status.py - Status query API endpoints

**Database:**
- apps/backend/src/database/models.py - Updated ProcessTracking model
- apps/backend/alembic/versions/005_update_process_tracking_for_status.py - Migration

**Application:**
- apps/backend/src/main.py - Updated to include status routes
- apps/backend/src/core/analysis_processor.py - Updated to integrate with status tracking

## QA Results
*Results from QA Agent QA review of the completed story implementation*